#-*- coding:utf8 -*-
import nltk
import json
import sqlite3 as lite
import sys
import exceptions
import hashlib
from datetime import datetime
from Util import common
from etool import queue,logs
import boto


__processor__ = 'bloomberg_news_process'
log = logs.getLogger(__processor__)


def process(port,keyId,secret,operateDate):
    #get DB connection
    conn = boto.connect_sdb(keyId,secret)
    domain = conn.get_domain("bloomberg_news")
    sql = "select * from {} where updateDate = '{}'".format(operateDate)
    results = domain.select(sql)
    enrichedNewsList = []
    for result in results:
        enrichedNews = process_news(result)
        if enrichedNews:
            enrichedNewsList.append(enrichedNews)
    
    enrichedDomain = conn.get_domain("enriched_news")
    
    #Write the enricheNews to simpleDB and push them into ZMQ
    with queue.open(port, 'w', capture=True) as outq:
        for enrichedNews in enrichedNewsList:
            outq.write(enrichedNews)
            enrichedDomain.put_attributes(enrichedNews["embersId"], enrichedNews)

def process_news(article):
    try:
        content = article["content"]
        
        tokens = nltk.word_tokenize(content)
        stemmer = nltk.stem.snowball.SnowballStemmer('english')
        words = [w.lower().strip() for w in tokens if w not in [",",".",")","]","(","[","*",";","...",":","&",'"',"'","â€™"] and not w.isdigit()]
        words = [w for w in words if w.encode("utf8") not in nltk.corpus.stopwords.words('english')]
        stemmedWords = [stemmer.stem(w) for w in words]
        fdist=nltk.FreqDist(stemmedWords)
        
        updateTime = datetime.now().isoformat()
        
        enrichedData = {}
        enrichedData["derivedFrom"] = article["embersId"]
        enrichedData["title"] = article["title"]
        enrichedData["author"] = article["author"]
        enrichedData["postTime"] = article["postTime"]
        enrichedData["postDate"] =  article["postDate"]
        enrichedData["content"] = fdist
        enrichedData["stockIndex"] = article["stockIndex"]
        enrichedData["source"] = article["source"]
        enrichedData["updateTime"] = updateTime
        enrichedData["updateDate"] = datetime.strftime(datetime.now(),"%Y-%m-%d")
        embersId = hashlib.sha1(json.dumps(enrichedData)).hexdigest()
        enrichedData["emberdId"] = embersId
    except :
        log.info( "Error****: ", sys.exc_info()[0])
        enrichedData = {}
    finally:
        return enrichedData
    

    
if __name__ == "__mian__":
    if len(sys.argv)!= 2:
        print "Please Enter the RawNewsFilePath as parameter: "
        exit(0)
    
    rawNewsFilePath = sys.argv[1]
    execute(rawNewsFilePath)