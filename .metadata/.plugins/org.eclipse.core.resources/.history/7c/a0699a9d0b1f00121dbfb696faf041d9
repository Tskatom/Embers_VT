from Util import common
import os
from datetime import datetime

def init(cfgPath):
    common.init(cfgPath)
    
def import_historical_stock():
    #get the historical stock dir
    stockFileDir = common.get_configuration("training", "HISTORICAL_STOCK")
    fileNames = os.listdir(stockFileDir)
    con = common.getDBConnection()
    cur = con.cursor()
    sql = "insert into t_daily_stockindices (sub_sequence,stock_index,date,last_price,one_day_change) values (?,?,?,?,?)";
    
    for filename in fileNames:
        fpath = stockFileDir + "/" + filename
        stock = filename.split(".")[0]
        print fpath,stock
        subSequence = 0
        with open(fpath,"r") as stockFile:
            lines = stockFile.readlines()[2:]
            for line in lines:
                line = line.replace("\r","").replace("\n","")
                print line
                date = line.split(",")[0]
                lastPrice = line.split(",")[1]
                previousLastPrice = line.split(",")[2]
                
                if lastPrice == "#N/A N/A" or previousLastPrice == "#N/A N/A":
                    continue
                date = datetime.strptime(date,"%m/%d/%Y").strftime("%Y-%m-%d")
                oneDayChange = round(lastPrice - previousLastPrice,4)
                subSequence = subSequence + 1
                cur.execute(sql,(subSequence,stock,date,lastPrice,oneDayChange,))
                if subSequence % 300 == 0:
                    con.commit()
                
        
if __name__ == "__main__":
    init("../Config/config.cfg")
    import_historical_stock()
            